
⚠️ Avertissement ⚠️
Ce code est fourni sans garantie.
Utilisation à vos propres risques.

Je ne suis pas responsable des dysfonctionnements de Home Assistant ou de votre installation électrique.
Votre système soalire doit être capable de gérer les variations de production solaire et notament suporter 32amp de décharge sur batterie. Sinon, vous risquez d'endommager vos batteries si homeassistant plante.

⚠️supprimer cette avertisement du code pour qu'il fonctionne⚠️

# https://youtu.be/NQe61K7PITc
# code écrit pour piloter un charger chinois de voiture elec https://fr.aliexpress.com/item/1005005504929776.html?spm=a2g0o.order_list.order_list_main.41.121e5e5bxzzMkQ&gatewayAdapt=glo2fra
# Pilote aussi un onduleur pour panneaux solaire de marque WKS sur bas voltronic, avec un addon homeassistant smartphoton

# ==============================================================================
# Paramètres de Configuration - À Adapter Selon Votre Installation
# ==============================================================================

# Remplacez les entités ci-dessous par celles correspondant à votre installation a l'aide de CTL-F > Remplacer TExt par autre text

##### sensors:
# sensor.fl995hk_batterie                       # Niveau SOC batterie  voiture
# sensor.chargeurvoiture_status                 # Statut du chargeur de la borne de charge
# sensor.combined_power_jk_bms                    # Amperage de charge ou décharge de la batterie maison
# sensor.bms_1_soc_pourcentage                 # État de charge de la batterie maison
# sensor.linky_relais                           # Statut du relais Linky  pour déclancher les heures creuses
# sensor.onduleur_tongou_power                  # puissance soutiré a l'onduleur en watt je limite le conso de ma maison a 9000w dans le code "solair"
# sensor.onduleur_tongou_current                # puissance soutiré a l'onduleur en AMpers 
# sensor.voltronic_1_mode_info                  # Vérifie si l'onduleur est en mode "edf" 

##### Entités de Sélection
#  select.chargeurvoiture_toggle_charging     #Si vous utiliser la meme borne que moi ne toucher pas a ca. c'est le bouton on/off par defaut
# - "on"
# - "off"

###### parametre onduleur pour passer GRID ou BATTERIE
# Dans le mode HC le code force la passage de mon onduleur des batterie maison au reseau le selecteur est le suivant:
# select.voltronic_1_param01
#
# il ya deux options possible dans ce selecteur 
#    - "UTI"  # GRID/reseau
#    - "SBU"  # Batterie maison


# Commande le bouton de l'ampérage mais en ralentie. le bouton "virtuel" comande son jumeau réèl lui.
# pour que ca fonction il faut aussi copier coller mon script sur gitub nomé "adjust_charge_current" et le coller dans votre script.yaml
- id: sync_charge_current_with_virtual
  alias: "Sync Charge Current with Virtual"
  trigger:
    - platform: state
      entity_id: input_number.chargeurvoiture_set_chargevirtuel_current
  condition: []
  action:
    - service: script.adjust_charge_current
      data:
        target_value: "{{ trigger.to_state.state | float }}"
        
        

##################################################################################################
################################  début du code de charge   ######################################
##################################################################################################

# Automatisation pour la gestion de la charge de la voiture électrique 
- id: Gestion_de_la_charge_ve
  alias: "Gestion de la charge voiture électrique"
  trigger:
    - platform: state
      entity_id:
        - sensor.fl995hk_batterie
        - input_number.ve_coupure_pourcentage
        - sensor.chargeurvoiture_status
        - input_select.SelecteurChargeurVE
        - sensor.combined_power_jk_bms
        - sensor.bms_1_soc_pourcentage
        - number.chargeurvoiture_set_charge_current
        - sensor.onduleur_tongou_power

  condition: []
  
  action:
    - choose:

      ################### Mode "Si déconnecté" ###################
      - conditions:
          - condition: state
            entity_id: sensor.chargeurvoiture_status
            state: "disconnected"
          - condition: template
            value_template: >
              {{ not is_state('input_select.SelecteurChargeurVE', 'off') }}
        sequence:
          - service: input_select.select_option
            data:
              entity_id: input_select.SelecteurChargeurVE
              option: "Solar"
          - service: number.set_value
            data:
              entity_id: number.chargeurvoiture_set_charge_current
              value: 8
          - service: select.select_option
            data:
              entity_id: select.chargeurvoiture_toggle_charging
              option: "off"

      ################### Mode "On No Limits" ###################
      - conditions:
          - condition: state
            entity_id: input_select.SelecteurChargeurVE
            state: "On No Limits"
          - condition: template
            value_template: >
              {{ not is_state('sensor.chargeurvoiture_status', 'available') }}
        sequence:
          - service: select.select_option
            data:
              entity_id: select.chargeurvoiture_toggle_charging
              option: "on"

      ################### Mode "On Limited" ###################
      - conditions:
          - condition: state
            entity_id: input_select.SelecteurChargeurVE
            state: "On Limited"
          - condition: template
            value_template: >
              {{ not is_state('sensor.chargeurvoiture_status', 'available') }}
        sequence:
          - choose:
              # Démarrer si batterie Zoé < seuil et pas déjà en charge
              - conditions:
                  - condition: template
                    value_template: >
                      {{ states('sensor.fl995hk_batterie') | float
                         < states('input_number.ve_coupure_pourcentage') | float }}
                  - condition: template
                    value_template: >
                      {{ not is_state('sensor.chargeurvoiture_status', 'charging') }}
                sequence:
                  - service: select.select_option
                    data:
                      entity_id: select.chargeurvoiture_toggle_charging
                      option: "on"

              # Arrêter si batterie Zoé ≥ seuil et en charge, puis repasser en Solar
              - conditions:
                  - condition: template
                    value_template: >
                      {{ states('sensor.fl995hk_batterie') | float
                         >= states('input_number.ve_coupure_pourcentage') | float }}
                  - condition: template
                    value_template: >
                      {{ is_state('sensor.chargeurvoiture_status', 'charging') }}
                sequence:
                  - service: select.select_option
                    data:
                      entity_id: select.chargeurvoiture_toggle_charging
                      option: "off"
                  - service: input_select.select_option
                    data:
                      entity_id: input_select.SelecteurChargeurVE
                      option: "Solar"

      ################### Mode "Heures-Creuses" ###################
      - conditions:
          - condition: state
            entity_id: input_select.SelecteurChargeurVE
            state: "Heures-Creuses"
          - condition: template
            value_template: >
              {{ not is_state('sensor.chargeurvoiture_status', 'available') }}
        sequence:
          - choose:
              - conditions:
                  - condition: numeric_state
                    entity_id: sensor.onduleur_tongou_current
                    above: 45
                  - condition: template
                    value_template: >
                      {{ is_state('sensor.chargeurvoiture_status', 'charging') }}
                sequence:
                  - service: select.select_option
                    data:
                      entity_id: select.chargeurvoiture_toggle_charging
                      option: "off"
                  - service: notify.notify
                    data:
                      title: "Charge voiture arrêtée"
                      message: "La consommation a dépassé 45 A."
                  - delay: "00:10:00"

              - conditions:
                  - condition: state
                    entity_id: sensor.linky_relais
                    state: "1"
                  - condition: state
                    entity_id: sensor.voltronic_1_mode_info
                    state: "solaire"
                sequence:
                  - service: select.select_option
                    data:
                      entity_id: select.voltronic_1_param01
                      option: "UTI"
                  - delay: "00:01:00"

              - conditions:
                  - condition: state
                    entity_id: sensor.linky_relais
                    state: "1"
                  - condition: template
                    value_template: >
                      {{ states('sensor.fl995hk_batterie') | float
                         < states('input_number.ve_coupure_pourcentage') | float }}
                  - condition: state
                    entity_id: sensor.chargeurvoiture_status
                    state: "charged"
                  - condition: state
                    entity_id: sensor.voltronic_1_mode_info
                    state: "edf"
                sequence:
                  - service: select.select_option
                    data:
                      entity_id: select.chargeurvoiture_toggle_charging
                      option: "on"

              - conditions:
                  - condition: template
                    value_template: >
                      {{ states('sensor.fl995hk_batterie') | float
                         >= states('input_number.ve_coupure_pourcentage') | float }}
                  - condition: state
                    entity_id: sensor.chargeurvoiture_status
                    state: "charging"
                sequence:
                  - service: select.select_option
                    data:
                      entity_id: select.chargeurvoiture_toggle_charging
                      option: "off"
                  - delay: "00:00:30"
                  - choose:
                      - conditions:
                          - condition: numeric_state
                            entity_id: sensor.bms_1_soc_pourcentage
                            above: 40
                        sequence:
                          - service: select.select_option
                            data:
                              entity_id: select.voltronic_1_param01
                              option: "SBU"

              - conditions:
                  - condition: state
                    entity_id: sensor.linky_relais
                    state: "0"
                  - condition: state
                    entity_id: sensor.chargeurvoiture_status
                    state: "charging"
                sequence:
                  - service: select.select_option
                    data:
                      entity_id: select.chargeurvoiture_toggle_charging
                      option: "off"
                  - delay: "00:00:30"
                  - choose:
                      - conditions:
                          - condition: numeric_state
                            entity_id: sensor.bms_1_soc_pourcentage
                            above: 30
                        sequence:
                          - service: select.select_option
                            data:
                              entity_id: select.voltronic_1_param01
                              option: "SBU"
                      - conditions:
                          - condition: numeric_state
                            entity_id: sensor.bms_1_soc_pourcentage
                            above: 50
                        sequence:
                          - service: select.select_option
                            data:
                              entity_id: select.voltronic_1_param01
                              option: "SBU"

      ################### Mode "Solaire" ###################
      - conditions:
          - condition: state
            entity_id: input_select.SelecteurChargeurVE
            state: "Solar"
          - condition: template
            value_template: >
              {{ not is_state('sensor.chargeurvoiture_status', 'available') }}
          - condition: template
            value_template: >
              {{ states('sensor.bms_1_soc_pourcentage') | float > states('input_number.ve_demarage_solaire') | float }}
          - condition: template
            value_template: >
              {{ not is_state('sensor.voltronic_1_mode_info', 'edf') }}
        sequence:
          - choose:
              # Démarrer si production solaire ≥ –2 A
              - conditions:
                  - condition: numeric_state
                    entity_id: sensor.combined_power_jk_bms
                    above: -2
                  - condition: state
                    entity_id: input_select.SelecteurChargeurVE
                    state: "Solar"
                sequence:
                  - service: number.set_value
                    data:
                      entity_id: number.chargeurvoiture_set_charge_current
                      value: 8
                  - delay: "00:00:10"
                  - service: select.select_option
                    data:
                      entity_id: select.chargeurvoiture_toggle_charging
                      option: "on"
                  - delay: "00:00:10"
          - repeat:
              while:
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: sensor.chargeurvoiture_status
                      state: "charging"
                    - condition: state
                      entity_id: input_select.SelecteurChargeurVE
                      state: "Solar"
              sequence:
                # Arrêt si batterie maison < 30 %
                - choose:
                    - conditions:
                        - condition: numeric_state
                          entity_id: sensor.bms_1_soc_pourcentage
                          below: 30
                      sequence:
                        - service: select.select_option
                          data:
                            entity_id: select.chargeurvoiture_toggle_charging
                            option: "off"
                        - service: persistent_notification.create
                          data:
                            notification_id: "voiture_charge_batterie_basse"
                            title: "Arrêt de la charge de la voiture"
                            message: "La batterie maison est faible."
                # Notification d’erreur si statut = error
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: sensor.chargeurvoiture_status
                          state: "error"
                      sequence:
                        - service: persistent_notification.create
                          data:
                            notification_id: "borne_recharge_erreur"
                            title: "Erreur borne recharge"
                            message: "La borne est en erreur."
                # Attente d’un nouveau relevé solaire
                - wait_for_trigger:
                    - platform: state
                      entity_id: sensor.combined_power_jk_bms
                - variables:
                    power: "{{ states('sensor.combined_power_jk_bms') | float }}"
                    current: "{{ states('number.chargeurvoiture_set_charge_current') | float }}"
                - choose:
                    # Réduction si onduleur > 9000 W
                    - conditions:
                        - condition: numeric_state
                          entity_id: sensor.onduleur_tongou_power
                          above: 9000
                      sequence:
                        - service: number.set_value
                          data:
                            entity_id: number.chargeurvoiture_set_charge_current
                            value: "{{ current - 3 }}"
                        - delay: "00:00:02"
                    # Ajustement si production < –5 A
                    - conditions:
                        - condition: numeric_state
                          entity_id: sensor.combined_power_jk_bms
                          below: -5
                      sequence:
                        - choose:
                            # Rapide (< –21 A)
                            - conditions:
                                - condition: numeric_state
                                  entity_id: sensor.combined_power_jk_bms
                                  below: -21
                                - condition: template
                                  value_template: >
                                    {{ current > 10 }}
                              sequence:
                                - service: number.set_value
                                  data:
                                    entity_id: number.chargeurvoiture_set_charge_current
                                    value: "{{ current - 3 }}"
                                - delay: "00:00:03"
                            # Lent (entre –20 et –6 A)
                            - conditions:
                                - condition: and
                                  conditions:
                                    - condition: numeric_state
                                      entity_id: sensor.combined_power_jk_bms
                                      above: -20
                                    - condition: numeric_state
                                      entity_id: sensor.combined_power_jk_bms
                                      below: -6
                              sequence:
                                - delay: "00:00:06"
                                - variables:
                                    current: "{{ states('number.chargeurvoiture_set_charge_current') | float }}"
                                - service: number.set_value
                                  data:
                                    entity_id: number.chargeurvoiture_set_charge_current
                                    value: "{{ current - 1 }}"
                                - delay: "00:00:03"
                            # Boucle N2 si courant = 8 A
                            - conditions:
                                - condition: template
                                  value_template: >
                                    {{ current <= 8 }}
                              sequence:
                                - repeat:
                                    while:
                                      - condition: numeric_state
                                        entity_id: sensor.combined_power_jk_bms
                                        below: -8
                                    sequence:
                                      - delay: "00:01:00"
                                      - choose:
                                          - conditions:
                                              - condition: numeric_state
                                                entity_id: sensor.combined_power_jk_bms
                                                below: -8
                                            sequence:
                                              - service: select.select_option
                                                data:
                                                  entity_id: select.chargeurvoiture_toggle_charging
                                                  option: "off"
                                              - delay: "00:10:00"
                    # Augmentation si surplus ≥ 1 A et SOC < 95 %
                    - conditions:
                        - condition: numeric_state
                          entity_id: sensor.combined_power_jk_bms
                          above: 1
                        - condition: numeric_state
                          entity_id: sensor.bms_1_soc_pourcentage
                          below: 95
                        - condition: numeric_state
                          entity_id: sensor.onduleur_tongou_power
                          below: 9000
                      sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: >
                                    {{ current < 32 }}
                              sequence:
                                - service: number.set_value
                                  data:
                                    entity_id: number.chargeurvoiture_set_charge_current
                                    value: "{{ current + 1 }}"
                                - delay: "00:00:02"
                    # Forçage si SOC > 94 % et légère décharge (> –40 A)
                    - conditions:
                        - condition: numeric_state
                          entity_id: sensor.combined_power_jk_bms
                          above: -40
                        - condition: numeric_state
                          entity_id: sensor.bms_1_soc_pourcentage
                          above: 94
                        - condition: numeric_state
                          entity_id: sensor.onduleur_tongou_power
                          below: 9000
                      sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: >
                                    {{ current < 32 }}
                              sequence:
                                - service: number.set_value
                                  data:
                                    entity_id: number.chargeurvoiture_set_charge_current
                                    value: "{{ current + 2 }}"
                                - delay: "00:00:02"

      ################### Mode "off" ###################
      - conditions:
          - condition: state
            entity_id: input_select.SelecteurChargeurVE
            state: "off"
          - condition: template
            value_template: >
              {{ not is_state('sensor.chargeurvoiture_status', 'available') }}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ states('sensor.chargeurvoiture_status') in ['charging', 'plugged_in'] }}
                sequence:
                  - service: select.select_option
                    data:
                      entity_id: select.chargeurvoiture_toggle_charging
                      option: "off"

      default: []

  mode: single  # Empêche l'exécution parallèle

